@using Resources = TetraTech.TTProjetPlus.Views.ManageDirectoryRights
@using Resources1 = TetraTech.TTProjetPlus.Views.Securite
@using ArchiveResources = TetraTech.TTProjetPlus.Views.ArchiveProjet
@using TetraTech.TTProjetPlus.Models
@model TetraTech.TTProjetPlus.Models.ManageDirectoryRightsViewModel
@using InfoResources = TetraTech.TTProjetPlus.Views.Home.informations
@using TetraTech.TTProjetPlus.Controllers
@using TetraTech.TTProjetPlus.Security
@using Resources3 = TetraTech.TTProjetPlus.Views.TTProjet

@using Resources2 = TetraTech.TTProjetPlus.Views.ManageDirectoryRights


@{
    ViewBag.Title = Resources.MDRessources.Title;
    var currentUser = UserService.CurrentUser;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>
<style>
    .fade {
        opacity: 0;
        -webkit-transition: opacity .3s linear;
        transition: opacity .3s linear
    }

    .modal-content {
        box-shadow: none;
        border: none;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px
    }

    .modal-content, .popover {
        -webkit-box-shadow: none
    }

    .modal-header {
        border-bottom: 2px solid #EAEDEF;
        padding: 15px 20px 12px
    }

    .modal-body, .modal-footer {
        padding: 15px 20px
    }

    .modal-footer {
        border-top: 2px solid #EAEDEF
    }

    .modal-message .modal-dialog {
        width: 100%;
        margin: 0
    }

    .modal-message .modal-content {
        -webkit-border-radius: 0;
        -moz-border-radius: 0;
        border-radius: 0
    }

    .modal-message .modal-body, .modal-message .modal-footer, .modal-message .modal-header {
        width: 60%;
        border: none;
        margin: 0 auto
    }

    .modal-backdrop.in {
        opacity: .3;
        filter: alpha(opacity=30)
    }

    .modal {
        position: absolute;
        top: 200px;
        right: 250px;
        bottom: 0;
        left: 0;
        z-index: 10040;
        height: 800px;
    }

    i {
        background: white;
        cursor: pointer;
    }

    .fa-remove, .k-i-close {
        color: red;
        font-weight: 100;
    }

    table tr:hover {
        background-color: #f5f5f5;
    }

    .buttonInactif {
        background-color: gray !important;
    }

    .allDisabled {
        pointer-events: none;
    }
</style>

<div class="form-horizontal">
    <div id="top"></div>

    <div class="container " style="height: 100%; width: 100%">
        <div class="main">
            <div class="row">
                <div class="row">
                    <div class="col-lg-3" style="padding-top: -49px;">
                        <div class="panel" style="border-radius: 10px; margin-left: -10px; height: 99px; ">
                            <div class="panel-body">
                                <ul class="list-inline">
                                    <li><a style=" color:#183666;" href="@Url.Action("Index", "TTProjet")">TT Projet +  /</a></li>
                                    <li style="color:#183666 ; font-weight: bold"><a href="@Url.Action("Index2", "ArchiveProjet")"> @ArchiveResources.ArchiveProjetRessource.Administration </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="">
                            <div class="panel" style="border-radius: 10px; margin-left: -10px; height: 99px; ">
                                <div class="panel-body">
                                    <ul class="list-inline">
                                        <li>
                                            &bull;&nbsp;
                                            <a style="color:#183666 ; " href="@Url.Action("Index2", "ArchiveProjet")">@ArchiveResources.ArchiveProjetRessource.ArchiveProject</a>
                                        </li>
                                        <br>
                                        <li>
                                            &bull;&nbsp;
                                            <a style="color: #183666; " href="@Url.Action("Index", "ArchiveProjet")">@ArchiveResources.ArchiveProjetRessource.ArchiveProject1</a>
                                        </li>

                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="">
                            <div class="panel" style="border-radius: 10px; margin-left: -10px; height: 99px; ">
                                <div class="panel-body">
                                    <ul class="list-inline">
                                        <li>
                                            &bull;&nbsp;
                                            <a style="color:#183666" href="@Url.Action("Index", "Securite")">@Resources1.Securite.CreateNumberAccessManagement</a>
                                        </li>
                                        <br>
                                        <li>
                                            &bull;&nbsp;
                                            <a style="color: #183666; font-weight: bold" href="@Url.Action("Index", "ManageDirectoryRights")">@Resources.MDRessources.Title</a>
                                        </li>
                                        <br>
                                        <li>
                                            &bull;&nbsp;
                                            <a style="color: #183666; " href="@Url.Action("Index", "Gestion10Conf")">@Resources3.TTProjet.Manage10Conf</a>
                                        </li>

                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="panel panel-primary" style="border-radius: 10px; margin-top: -15px; margin-left: -10px">
                            <div class="panel-body">
                                <div class="row" id="ManageDirectorySection" hidden>
                                    <div class="col-sm-1   tt-h3-darkblue" ; style=" width : 15%"> @Html.DisplayNameFor(model => model.DirectoryRightList)   </div>
                                    <div class="col-sm-7" ; style=" width : 35%">
                                        <select data-live-search="true" class="form-control selectpicker userInput" id="SelectedDirectoryRight">
                                            @foreach (SelectListItem item in ManageDirectoryRightsController.ListeDirectoryRights)
                                            {
                                                <option value="@item.Value">@item.Value</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-sm-6"></div>
                                </div>
                                <div class="row"><div class="col-sm-12"><p></p></div></div>
                                <div class="row" id="ProjectSection" hidden>
                                    <div class="col-sm-1 tt-h3-darkblue" ; style=" width : 15%"> @Resources.MDRessources.ProjectList</div>
                                    <div class="col-sm-5" ; style=" width : 25%">
                                        <select data-live-search="true" class="form-control selectpicker userInput" id="SelectedProject">
                                            <option value="" selected style="font-size: 16px !important">@Resources.MDRessources.SelectProject</option>
                                            @foreach (SelectListItem item in ManageDirectoryRightsController.ListeProjets)
                                            {
                                                <option value="@item.Value">@item.Value</option>
                                            }
                                        </select>
                                    </div>
                                    <div>
                                        <div id="DirectorySection">
                                            @Html.Partial("~/Views/ManageDirectoryRights/_DetailsDirectory.cshtml", Model.DirectoryRightsDetails)
                                        </div>
                                    </div>
                                    <div class="col-sm-6"><label id="TitrePrivilege" style="color: #5482ab;" hidden>@Resources.MDRessources.TTAccountRole&nbsp;</label><label id="DescriptionPrivilege" style="color: #5482ab;font-weight:normal" hidden></label></div>
                                </div>
                                <div class="row"><p></p></div>
                            </div>
                        </div>
                        <div id="panelDetails" class="panel panel-primary" style="border-radius: 10px" hidden>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-sm-7" id="SecurityDirectoryForProjectAndDirectorySection" style="padding: 10px;">
                                        @Html.Partial("~/Views/ManageDirectoryRights/_DetailsSecurityDirectoryForProjectAndDirectory.cshtml", Model.DirectoryRightsDetails)
                                    </div>
                                    <div class="col-sm-5">
                                        <div class="row">
                                            <div class="col-sm-11">
                                                @if (Session["lang"].ToString() == "fr")
                                                {
                                                    <div id="MessageSteps" class="alert alert-info" role="alert">
                                                        <U>ÉTAPES À SUIVRE</U><br><br><b>Ajout d'un accès:</b><br>1- Saisir le nom et prénom de l'employé dans le contrôle de la section "Ajouter un employé"<br>2- Sélectionnez le type de permission désiré<br>3- Cliquez sur le bouton "Ajouter"<br>4- Cliquez sur le bouton "Sauvegarder" afin de conserver les changements effectués et mettre à jour la sécurité du répertoire de projet<br><br>
                                                        <b>Suppression d'un accès:</b><br>1- Dans le tableau de gauche, cliquez sur le bouton "Supprimer" vis-à-vis du nom de l'employé pour lequel vous désirez supprimer l'accès<br>4- Cliquez sur le bouton "Sauvegarder" afin de conserver les changements effectués et mettre à jour la sécurité du répertoire de projet
                                                    </div>}
                                                else
                                                {
                                                    <div id="MessageSteps" class="alert alert-info" role="alert">
                                                        <U>STEPS TO FOLLOW</U><br><br><b>Adding an access:</b><br>1- Enter the employee's first and last name in the section "Add employe" section<br>2- Select the permission type required<br>3- Click on the "Add" button<br>4- Click on the "Save" button when all additions are made to retain and apply the changes<br><br>
                                                        <b>Deleting an access:</b><br>1- In the table on the left, click on the "Remove" button next to the name of the employee for whom you want to delete the access<br>4- Click on the "Save" button when all additions are made to retain and apply the changes
                                                    </div>
                                                }
                                            </div>
                                            <div class="col-sm-1"></div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-11">
                                                <div class="panel panel-default">
                                                    <div class="panel-heading tt-h3-darkblue"> @Resources.MDRessources.AddEmployee </div>
                                                    <div class="panel-body">
                                                        <div class="row"><p></p></div>
                                                        <div class="row">
                                                            <div class="col-sm-7">
                                                                <div class="input-group ">
                                                                    <input type="hidden" id="EmployeeNumber" name="EmployeeNumber" value="">
                                                                    @Html.EditorFor(m => m.SelectedEmployeeName, "", new { htmlAttributes = new { @class = "form-control formControl2 inputWidth2 userInput", @placeholder = @Resources.MDRessources.Employee, @style = "border-right: none;" } })
                                                                    <div class="input-group-addon" onclick="openModalEmployee('')">
                                                                        <i class="fa fa-search"></i>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-sm-3">
                                                                <select data-live-search="true" class="form-control selectpicker" id="Permission" onchange="keepPermissionValue()">
                                                                    <option value="" selected style="font-size:16px">@Resources.MDRessources.SelectPermission</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-sm-2">
                                                                <button class="btn btn-primary btn-block" onclick="addEmployee()">@Resources.MDRessources.Add</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-1"></div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-11">
                                                <div id="EmployeeMessagesDanger" class="details-messages alert alert-danger" role="alert" style="display:none;padding:.5em;margin:0;">  <span></span> </div>
                                                <div id="EmployeeMessagesSuccess" class="details-messages alert alert-success" role="alert" style="display:none;padding:.5em;margin:0;">  <span></span> </div>
                                            </div>
                                            <div class="col-sm-1"></div>
                                        </div>
                                        <div class="row"><p></p></div>
                                        <div class="row">
                                            <div class="col-sm-11">
                                                <div id="MessageSave" class="alert alert-warning" role="alert" style="display:none;">@Resources.MDRessources.SaveWarning</div>
                                            </div>
                                            <div class="col-sm-1"></div>
                                        </div>
                                        <div class="row"><p></p></div>
                                        <div class="row">
                                            <div class="col-sm-9"></div>
                                            <div class="col-sm-2">
                                                <button id="btnSave" class="btn btn-primary btn-block buttonInactif" onclick="saveToDatabase()">@Resources.MDRessources.Save</button>
                                            </div>
                                            <div class="col-sm-1"></div>
                                        </div>
                                        <div class="row"><p></p></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal modal-message fade" id="EmployeeModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-xl1" role="document">
        <div class="modal-content" style="width:100%;">
            <div class="modal-header" style="width:100%;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="modalLabelGP">@Resources.MDRessources.EmployeesList</h4>
            </div>
            <div class="modal-body" id="contentEmployees" style="width:100%;">
            </div>
            <div class="modal-footer" style="width:100%;">
                <button type="button" class="specialB" data-dismiss="modal" id="cancelProjectMgr">@Resources.MDRessources.Cancel</button>
                <button type="button" class="specialB" onclick="applyEmployeeModalModalValue()">@Resources.MDRessources.OK</button>

            </div>
        </div>
    </div>
</div>

<script>

    var employeeDisplayName = "";
    var employeeNumber = "";

$(document).ready(function () {
    $("#ManageDirectorySection").show();
    $("#ProjectSection").show();
});

$(function() {
var array = @Html.Raw(Json.Encode(@ViewBag.EmployeesArray));
var numberArray = [];
    for (var i = 0; i < array.length; i++)
        {
        numberArray[i] = { value: array[i], label: array[i] };
        }
    $("#SelectedEmployeeName").autocomplete(
            {
                  source: numberArray,
                  focus: function (event, ui)
                         {

                      $("#SelectedEmployeeName").val(ui.item.label);
                        return false;

                        }
                  ,
                change: function (event, ui) {
                    if ($("#SelectedEmployeeName").val() != "") {
                        if (ui.item === null || !ui.item)
                        $("#SelectedEmployeeName").val("@Html.Raw(@Resources.MDRessources.EmployeeNotInList)");
                    }

                }
            }
    )
     .autocomplete("instance")._renderItem = function (ul, item)
     {
        return $( "<li>" )
        .append( "<div>" + item.label + "</div>" )
        .appendTo( ul );
        };
});

    $('#SelectedProject').on('change', function () {
        if ($('#SelectedProject').val() != null) {

            $("#panelDetails").hide();
            document.getElementById("TitrePrivilege").className = 'hidden';
            document.getElementById("DescriptionPrivilege").className = 'hidden';

            var SelectedProject = $('#SelectedProject').val();
        $.post('@Url.Action("GetDirectoryList", "ManageDirectoryRights")', { SelectedProject: SelectedProject}, function (result) {
            $("#DirectorySection").html(result);
        });
      }
    });

    var Directory_select = function (e) {
        var SelectedDirectoryRight = $("#SelectedDirectoryRight").val();
        var SelectedDirectoryId = this.value();
        var SelectedDirectory = this.text();
        var SelectedProject = $('#SelectedProject').val();
        var SelectedPermission = $("#Permission").val();

        $("#SecurityDirectoryForProjectAndDirectorySection").html("");
        $("#MessageSave").hide();

        $.ajax({
                url: '@Url.Action("resetObjDetails", "ManageDirectoryRights")',
                type: 'GET',
                cache: false,
                async:false,
                data: {
                },
                success: function (result)
                {
                }
            });

        $.ajax({
            type: "POST",
            url: '@Url.Action("GetSecurityDirectoryForProjectAndDirectory", "ManageDirectoryRights")',
            async: false,
            cache: false,
            data: { SelectedProject: SelectedProject, SelectedDirectoryId: SelectedDirectoryId, SelectedDirectory: SelectedDirectory },
            success: function (result) {
                $("#SecurityDirectoryForProjectAndDirectorySection").html(result);

                 $.ajax({
                    url: '@Url.Action("returnPermissionList", "ManageDirectoryRights")',
                    type: 'GET',
                    data: {

                        SelectedDirectoryRight: SelectedDirectoryRight, SelectedDirectory: SelectedDirectoryId, SelectedProject: SelectedProject, SelectedPermission: SelectedPermission
                    },

                    success: function (data) {
                        $("#Permission").empty();
                        if (data == null || data == "") {
                            $("#Permission").append('<option value="">' + '' + '</option >');
                        }
                        else {

                            $.each(data, function (index, row) {

                                $("#Permission").append('<option value="'
                                    + row.Value + '">'
                                    + row.Name + '</option>');
                            });
                        }
                        $('#Permission').selectpicker('refresh');
                        $(".dropdown-toggle").removeAttr("title");
                    }
                });

                UpdateRightLevel(SelectedDirectory);

                $('#btnSave').attr('disabled', 'disabled');
                $('#btnSave').addClass("buttonInactif");

                $("#panelDetails").show();
            }
        });

         $.ajax({

            type: 'GET',
            dataType: 'html',
            cache: false,
            url: '@Url.Action("returnListEmployes", "ManageDirectoryRights")',
            success: function (result) {
                $("#contentEmployees").html(result);
            }
        });
    };

    function UpdateRightLevel(directory) {
                $.ajax({
                url: '@Url.Action("GetRightLevel", "ManageDirectoryRights")',
                type: 'GET',
                        cache: false,
                async:false,
                data: {
                    directory: directory,
                },
                success: function (result)
                {
                    $("#TitrePrivilege").show();
                    document.getElementById("TitrePrivilege").className = '';
                    document.getElementById("DescriptionPrivilege").className = '';
                    $("#DescriptionPrivilege").html(result.stringReturn);
                    $("#DescriptionPrivilege").show();
                }
            });
    }

    function keepPermissionValue() {

        var permission = $("#Permission").val();
        var selectedFolder = $("#ddlDirectoryList").val();

        $.ajax({
                url: '@Url.Action("keepPermissionValue", "ManageDirectoryRights")',
                type: 'GET',
                        cache: false,
                async:false,
                data: {
                    permission: permission,
                    selectedFolder: selectedFolder,
                },
                success: function (result)
                {
                }
            });
    }

    var refreshDetailsGroupMembersSection = function () {
        var SelectedDirectory = $("#ddlDirectoryList").val();
        var SelectedProject = $("#SelectedProject").val();

        $.post('@Url.Action("GetSecurityDirectoryForProjectAndDirectory", "ManageDirectoryRights")', { SelectedProject: SelectedProject, SelectedDirectoryId: SelectedDirectory, SelectedDirectory: SelectedDirectory }, function (result) {
            $("#SecurityDirectoryForProjectAndDirectorySection").html(result);
        });
    };

    function saveToDatabase() {
        var SelectedDirectory = $("#ddlDirectoryList").val();
        var SelectedProject = $("#SelectedProject").val();

        $("body").addClass("allDisabled");

            $.ajax({
                url: '@Url.Action("saveToDatabase", "ManageDirectoryRights")',
                type: 'GET',
                traditional: true,
                data: {
                    SelectedProject: SelectedProject,
                    SelectedDirectory: SelectedDirectory,
                },
                success: function (result)
                {
                    if (result.success == null)
                    {
                        $(".details-messages.alert-danger span").text("@Html.Raw(@Resources.MDRessources.SavingError)");
                        $(".details-messages.alert-danger").show();
                        setTimeout(function () {
                            $(".details-messages.alert-danger").fadeOut('slow');
                        }, 5000
                        );
                    }
                    else {
                        if (result.success)
                        {
                            $(".details-messages.alert-success span").text("@Html.Raw(@Resources.MDRessources.SavingSuccess)");
                            $(".details-messages.alert-success").show();
                            setTimeout(function () {
                                $(".details-messages.alert-success").fadeOut('slow');
                            }, 5000
                            );
                            $('#btnSave').attr('disabled', 'disabled');
                            $('#btnSave').addClass("buttonInactif");
                            $("#MessageSave").hide();
                            refreshDetailsGroupMembersSection();
                        }
                        else {

                            $(".details-messages.alert-danger span").text("@Html.Raw(@Resources.MDRessources.SavingError)");
                            $(".details-messages.alert-danger").show();
                            setTimeout(function () {
                                $(".details-messages.alert-danger").fadeOut('slow');
                            }, 5000
                            );                                   }
                    }
                    $("body").removeClass("allDisabled");
                }
        });
    }

    function openModalEmployee(origin) {
        clickOrigin = origin
        $('#EmployeeModal').modal('show');
    }

    function applyEmployeeModalModalValue() {
        if (employeeNumber != "") {
            $("#SelectedEmployeeName").val(employeeDisplayName);
            $("#EmployeeNumber").val(employeeNumber);

            employeeDisplayName = "";
            employeeNumber = "";
        }
        $('#data_projectManagerName tr').removeClass('selected');
        ($('input[type=search]')[0]).value = "";
        $('#data_projectManagerName').DataTable().search('').draw();
        $('#data_projectManagerName tr').removeClass('selected');
        $('#EmployeeModal').modal('toggle');
    }

    function addEmployee() {

        var invalidForm = false;

        if ($('#SelectedEmployeeName').val() == "") {
            invalidForm = true;
            $(".details-messages.alert-danger span").text("@Html.Raw(@Resources.MDRessources.MessageSelectEmployee)");

            $(".details-messages.alert-danger").show();
            setTimeout(function () {
                $(".details-messages.alert-danger").fadeOut('slow');
            }, 5000
            );
        }

        if (!invalidForm) {

            var SelectedProject = $("#SelectedProject").val();
            var SelectedEmployeeNumber = $("#EmployeeNumber").val();
            var SelectedEmployeeFullName = $("#SelectedEmployeeName").val();

            keepPermissionValue();

            $.ajax({
                url: '@Url.Action("AddEmployeeToDirectoryRight", "ManageDirectoryRights")',
                type: 'GET',
                traditional: true,
                data: {
                    strProjectNumber: SelectedProject,
                    strSelectedEmployeeFullName: SelectedEmployeeFullName,
                    strSelectedEmployeeNumber: SelectedEmployeeNumber
                },
                success: function (result)
                {
                    if (result.success == "true")
                    {
                        $(".details-messages.alert-success span").text(result.message);
                        $(".details-messages.alert-success").show();
                        setTimeout(function () {
                            $(".details-messages.alert-success").fadeOut('slow');
                        }, 5000
                        );
                        $("#MessageSave").show();

                        $('#btnSave').removeAttr('disabled');
                        $('#btnSave').removeClass("buttonInactif");
                        refreshDetailsGroupMembersSection();
                    }
                    else {
                        $(".details-messages.alert-danger span").text(result.message);
                        $(".details-messages.alert-danger").show();
                        setTimeout(function () {
                            $(".details-messages.alert-danger").fadeOut('slow');
                        }, 5000
                        );
                    }

                    $("#EmployeeNumber").val('');
                }
        });

        }
    }

</script>
